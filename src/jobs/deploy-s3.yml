description: >
  This job deploys an application to aws s3.

executor: node/default

parameters:
  SOURCE:
    type: string
    default: SOURCE
    description: >
      a local directory path to sync with s3

  S3_BUCKET:
    type: string
    defualt: S3_BUCKET
    description: >
      A URI to an S3 bucket

  tag:
    type: string
    description: >
      tag for the repo

  AWS_REGION:
    type: env_var_name
    default: AWS_REGION_N_VA
    description: >
      Specify the region for aws

  AWS_ACCESS_KEY_ID:
    type: env_var_name
    default: MACHINE_AWS_ECS_AccessKey
    description: >
      Access Key for MACHINE_AWS_ECS

  AWS_SECRET_ACCESS_KEY:
    type: env_var_name
    default: MACHINE_AWS_ECS_SecretKey
    description: >
      Secret Key for MACHINE_AWS_ECS

steps:
  - tag-repo:
      tag: <<parameters.tag>>
  - checkout
  - run:
      name: Install dependencies
      command: npm install
  - run:
      name: Build Application
      command: npm ng build --prod --no-progress
  - persist_to_workspace:
      root: ./dist
      paths:
        - ./
  - setup-aws:
      aws-access-key-id: <<parameters.AWS_ACCESS_KEY_ID>>
      aws-region: <<parameters.AWS_REGION>>
      aws-secret-access-key: <<parameters.AWS_SECRET_ACCESS_KEY>>
      version: "1"
  - aws-s3/sync:
      aws-region: <<parameters.AWS_REGION>>
      from: <<parameters.SOURCE>>
      to: s3://<<parameters.S3_BUCKET>>
  # - run:
  #     name: sync changes
  #     command: aws s3 sync ${SOURCE} s3://${S3_BUCKET} --region ${S3_REGION}
  - run:
      name: Invalidate index.html in CloudFront
      command: aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_ID} --paths /index.html
#TO-DO notify slack
  