description: |
  This job deploys an application to aws s3.

executor: node/default

parameters:
 # Required Parameters
  tag:
    type: string
    description: |
      The semantic version of the project trying to be deployed
      https://semver.org/spec/v2.0.0.html
 # Not Required Parameters
  s3-bucket:
    type: env_var_name
    default: S3_BUCKET
    description: |
      AWS S3 Bucket URI used to identify the resource

  source:
    type: env_var_name
    default: SOURCE
    description: |
      a local directory path to sync with s3

  aws-region:
    type: env_var_name
    default: AWS_REGION_N_VA
    description: |
      Name of environment variable storing the AWS region

  aws-access-key-id:
    type: env_var_name
    default: MACHINE_AWS_CF_AccessKey
    description: |
      AWS access key id for IAM role. Set this to the name of
      the environment variable you will use to hold this
      value, i.e. MACHINE_AWS_CF_AccessKey.

  aws-secret-access-key:
    type: env_var_name
    default: MACHINE_AWS_CF_SecretKey
    description: |
      AWS secret key for IAM role. Set this to the name of
      the environment variable you will use to hold this
      value, i.e. MACHINE_AWS_CF_SecretKey.

  slack-mentions:
    type: env_var_name
    default: MENTIONS
    description: |
      MENTIONS is the environment variable storing the name for the slack context.

steps:
  - checkout
  - tag-repo:
      tag: <<parameters.tag>>
  - run:
      name: Install dependencies
      command: npm install
  - run:
      name: Build Application
      command: ng build --aot --build-optimizer=true --optimization=true --configuration=production
  - aws-s3/sync:
      aws-region: <<parameters.aws-region>>
      aws-access-key-id: <<parameters.aws-access-key-id>>
      aws-secret-access-key: <<parameters.aws-secret-access-key>>
      from: <<parameters.source>>
      to: s3://<<parameters.s3-bucket>>
  - run:
      name: Invalidate index.html in CloudFront
      command: >
        aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths /index.html
  - slack/notify:
      event: fail
      mentions: "@<<parameters.slack-mentions>>"
      template: basic_fail_1
  - slack/notify:
      event: pass
      custom: "<<include(message_templates/deploy_aws_success.json)>>"
