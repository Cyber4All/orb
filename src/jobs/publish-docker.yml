description: >
  This job publishes a new version of the application to DockerHub and versions the Github image.

parameters:
  docker-password:
    type: env_var_name
    default: DOCKER_PASSWORD
    description: |
      Name of environment variable storing your Docker password
  docker-username:
    type: env_var_name
    default: DOCKER_USERNAME
    description: |
      Name of environment variable storing your Docker username
  gh_pat:
    type: env_var_name
    default: GH_PAT
    description: |
      Name of environment variable storing your Github Personal Access Token
  organization:
    type: string
    default: 'cyber4all'
    description: |
      Name of your docker organization
  image:
    type: string
    description: |
      Name of the image associated with your organization
  tag:
    type: string
    description: |
      Semantic Version of the application
  executor:
    type: executor
    description: |
      Name of the executor to run the job as

executor: <<parameters.executor>>

steps:
  - checkout
  - run:
      name: "Verify Parameters"
      command: |
        if [ -z "<<parameters.tag>>" ]; then
          echo '"tag" is missing.'
          exit 1
        fi

        if [ -z "<<parameters.image>>" ]; then
          echo '"image" is missing.'
          exit 1
        fi
  - setup-docker:
      docker-password: <<parameters.docker-password>>
      docker-username: <<parameters.docker-username>>
  - check-docker-semver:
      tag: <<parameters.tag>>
      organization: <<parameters.organization>>
      image: <<parameters.image>>
  - docker/build:
      debug: true
      image: "<<parameters.organization>>/<<parameters.image>>"
      lint-dockerfile: true
      tag: <<parameters.tag>>
  - tag-repo:
      tag: <<parameters.tag>>
      gh_pat: <<parameters.gh_pat>>
  - docker/push:
      digest-path: /tmp/digest.txt
      image: "<<parameters.organization>>/<<parameters.image>>"
      tag: <<parameters.tag>>
  - run:
      command: |
        echo "Digest is: $(</tmp/digest.txt)"
