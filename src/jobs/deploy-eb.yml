description: |
  This job deploys an application to aws elasticbeanstalk. Deploy-Eb requires publish-docker

environment:
  AWS_ACCESS_KEY_ID: <<parameters.aws-access-key-id>>
  AWS_SECRET_ACCESS_KEY: <<parameters.aws-secret-access-key>>
  AWS_REGION: <<parameters.aws-region>>
  YEET: "BEARS"

parameters:
  # Required Parameters
  application-name:
    type: string
    description: |
      The name of the elastic beanstalk instance that will be updated in this job
  environment-name:
    type: string
    description: |
      The name of the elastic beanstalk instance that was given during eb init
  version:
    type: string
    description: |
      The semantic version of the eb instance
  # Not Required Parameters
  aws-secret-access-key:
    type: env_var_name
    default: MACHINE_AWS_EB_SecretKey
    description: |
      The secret key for the aws user
  aws-access-key-id:
    type: env_var_name
    default: MACHINE_AWS_EB_AccessKey
    description: |
      The access key for the aws user
  aws-region:
    type: env_var_name
    default: AWS_REGION_N_VA
    description: |
      Env var of AWS region to operate in
      (defaults to AWS_REGION_N_VA)
  slack-mentions:
    type: env_var_name
    default: MENTIONS
    description: |
      MENTIONS is the environment variable storing the name for the slack context.
  isDocker:
    type: boolean
    default: true
    description: |
      The platform of the elastic beanstalk instance will be deployed with docker
  isNode:
    type: boolean
    default: false
    description: |
      The platform of the elastic beanstalk instance will be deployed with nodejs

executor: node/default

steps:
  - checkout
  - run:
      name: Verify Parameters
      command: |
        if [ -z "<<parameters.application-name>>" ]; then
          echo "application-name is missing"
          exit 1
        fi

        if [ -z "<<parameters.environment-name>>" ]; then
          echo "environment-name is missing"
          exit 1
        fi

        if [ -z "<<parameters.version>>" ]; then
          echo "Version is missing"
          exit 1
        fi

        if [ <<parameters.isNode>> ]; then
          echo 'export EB_PARAM_PLATFORM=node.js' >> $BASH_ENV
        elif [ <<parameters.isDocker>> ]; then
          echo 'export EB_PARAM_PLATFORM=docker' >> $BASH_ENV
        else
          echo 'Either "isNode" or "isDocker" must be true.'
          exit 1
        fi
  - aws-eb/setup
  - attach_workspace:
      at: .
  - run:
      name: Deploy to Elastic Beanstalk with docker platform
      command: |
        echo $AWS_REGION
        echo $YEET
        echo <<parameters.aws-region>>
        eb init "<<parameters.application-name>>" --region <<parameters.aws-region>> -p $EB_PARAM_PLATFORM
        eb deploy "<<parameters.environment-name>>" --verbose --label "${CIRCLE_PROJECT_REPONAME}-v<<parameters.version>>"
  - slack/notify:
      event: fail
      template: basic_fail_1
  - slack/notify:
      event: pass
      custom: "<<include(message_templates/deploy_aws_success.json)>>"
