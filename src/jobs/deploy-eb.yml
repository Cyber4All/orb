description: >
  This job deploys an application to aws elasticbeanstalk. Deploy-Eb requires publish-docker

executor: node/default

parameters:
  # Required Parameters
  aws-region:
    type: env_var_type
    default: AWS_REGION
    description: |
      The region where the elasticbeanstalk instance is located

  aws-secret-access-key-id:
    type: env_var_type
    default: AWS_SECRET_ACCESS_KEY_ID
    description: |
      The secret key for the aws user
  
  aws-access-key-id:
    type: env_var_type
    default: AWS_ACCESS_KEY_ID
    description: |
      The access key for the aws user

  application-name:
    type: string
    description: |
      The name of the elastic beanstalk instance that will be updated in this job
    
  environment-name:
    type: string

  version:
    type: string
    description: |
      The updated version of the eb instance

  is-docker:
    type: boolean
    default: true
    description: 

steps:
  - checkout
  - eb/setup

  # Tag after build success and version is unique
  - tag-repo:
      - tag: <<parameters.version>>
  # Ensure 
  - run:
    name: Install and init eb cli
    command: |
      pip install awsebcli
      
  - run:
      name: Deploy to Elastic Beanstalk
      command: |
        eb init --region "<<parameters.aws-region>>" "<<parameters.application-name>>" -p docker
        eb deploy production --verbose --label "<<parameters.service_name>>"-v"<<parameters.version>>"
