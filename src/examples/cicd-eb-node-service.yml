description: |
  This example shows how a node application being deployed to Elasticbeanstalk
  can setup a CICD pipeline with this orb.

usage:
  version: 2.1

  orbs:
    cyber4all: cyber4all/orb@1.0.4
    docker: circleci/docker@2.0.3

  workflows:
    integration-testing:
      jobs:

        - cyber4all/test-app:
            docker-image: cimg/node:16.15.0
            isNode: true

        - cyber4all/build-app:
            filters:
              branches:
                ignore: releases

    deploy-production:
      jobs:
        - cyber4all/build-app:
            filters:
              branches:
                only: releases

        - cyber4all/deploy-eb:
            requires:
              - cyber4all/build-app
            context:
              [AWS, Slack]
            application-name: CLARK-Gateway
            environment-name: clark-gateway-production
            version: $(cat ./package.json | grep version | head -1 | awk -F= "{ print $2 }" | sed 's/[version:,\",]//g' | tr -d '[[:space:]]')
            isNode: true # deploy to eb as a node.js project
            filters:
              branches:
                only: releases
